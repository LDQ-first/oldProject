"use strict";(function(t){t.fn.Sokoban=function(){var s=function(){function s(s){s.each(function(s,o){new i(t(o))})}function i(t){this.$target=t,this.pass=0,this.id=localStorage.getItem("gkId")||0,this.createMap(this.id)}return i.prototype={gkId:function(){localStorage.setItem("gkId",this.id)},gk:function(){t("#gk").on("keydown",t.proxy(function(s){if(13===s.which){var i=t("#gk").val(),o=parseInt(i);i.match(/^[1-9]*[1-9][0-9]*$/)&&o>=1&&o<=GK.gk.length&&(this.id=o-1,this.createMap(this.id))}},this))},btn:function(){t(".pre").on("click",t.proxy(function(){this.preGk()},this)),t(".next").on("click",t.proxy(function(){this.nextGk()},this)),t(".retract").on("click",t.proxy(function(){this.retract()},this)),t(".reset").on("click",t.proxy(function(){this.createMap(this.id)},this)),t(".instruction").on("click",t.proxy(function(){t(".playWay").slideToggle(400)},this))},preGk:function(){0!==this.id&&(this.id--,this.createMap(this.id))},nextGk:function(){this.id!==GK.gk.length-1&&(this.id++,this.createMap(this.id))},retract:function(){0!==this.moveNum&&(t(".person").css({left:50*this.x1,top:50*this.y1}),t(".person").data({x:this.x1,y:this.y1}),(0!=this.moveNum&&this.x2!=this.x1||this.y2!=this.y1)&&(this.moveNum--,t(".move-nmu").html(this.moveNum)),t(".box").each(t.proxy(function(s,i){t(i).data("idx")===this.boxIdx&&t(i).css({left:50*this.x2,top:50*this.y2})},this)),this.isSuccess())},show:function(s,i){var o='<div class="MesConCt"><div class="message"><h3>第<span class="gk-num">'+this.gkNum+'</span>关 移动次数: <span class="move-nmu">'+this.moveNum+'</span></h3><input id="gk" type="text" placeholder="1~'+GK.gk.length+'"></input><label for="gk" class="gk-text">关</label><p class="playWay">通过方向键或awds键控制人物的移动，目标是推动所有箱子到红色区域</p><p class="pass">恭喜你过关了</p></div><div class="control"><button class="pre">上一关</button><button class="next">下一关</button><button class="retract">撤销</button><button class="reset">重玩本关</button><button class="instruction">游戏说明</button></div></div>';this.$target.parent().append(o),t(".MesConCt").css({width:50*this.rowNum+100}),this.btn()},createMap:function(s){this.$target.empty(),t(".MesConCt").remove(),this.$target.append('<div class="game"></div>'),this.nowJson=GK.gk[s],this.gkNum=parseInt(s)+1,this.moveNum=0,this.rowNum=Math.sqrt(this.nowJson.length),console.log("createMap"),this.$target.css({width:50*this.rowNum}),t(".game").css({height:50*this.rowNum+20}),t(this.nowJson).each(t.proxy(function(s,i){0===i||3===i||4===i?this.ele="activity":1===i?this.ele="wall":2===i&&(this.ele="destination"),t(".game").append('<div class="pos-'+this.ele+'"></div>')},this)),this.createBox(),this.createPerson(),this.show(),this.gk(),this.gkId()},createBox:function(){t(this.nowJson).each(t.proxy(function(s,i){if(3===i){var o={};o.y=parseInt(s/this.rowNum),o.x=s-o.y*this.rowNum;var e=t('<div class="box"></div>');e.css({left:50*o.x,top:50*o.y}),e.data({idx:s}),t(".game").append(e)}},this))},createPerson:function(){t(this.nowJson).each(t.proxy(function(s,i){if(4===i){var o={};o.y=parseInt(s/this.rowNum),o.x=s-o.y*this.rowNum;var e=t('<div class="person"></div>');e.css({left:50*o.x,top:50*o.y}),e.data({x:o.x,y:o.y}),t(".game").append(e),t(document).off("keyup"),this.controlPerson(e)}},this))},controlPerson:function(s){t(document).on("keyup",t.proxy(function(t){switch(t.which){case 65:case 37:s.css({transform:"rotateZ(-90deg)"}),this.movePerson(s,{x:-1});break;case 87:case 38:s.css({transform:"rotateZ(0deg)"}),this.movePerson(s,{y:-1});break;case 68:case 39:s.css({transform:"rotateZ(90deg)"}),this.movePerson(s,{x:1});break;case 83:case 40:s.css({transform:"rotateZ(180deg)"}),this.movePerson(s,{y:1})}},this))},movePerson:function(s,i){var o=i.x||0,e=i.y||0;this.x1=s.data("x"),this.y1=s.data("y"),1!=this.nowJson[this.rowNum*(s.data("y")+e)+(s.data("x")+o)]&&(s.data({x:s.data("x")+o,y:s.data("y")+e}),s.css({left:50*s.data("x"),top:50*s.data("y")}),t(".box").each(t.proxy(function(i,a){this.pz(s,t(a))&&1!=this.nowJson[this.rowNum*(s.data("y")+e)+(s.data("x")+o)]?(t(a).css({left:50*(s.data("x")+o),top:50*(s.data("y")+e)}),this.boxIdx=t(a).data("idx"),t(".box").each(t.proxy(function(i,n){this.pz(t(a),t(n))&&a!=n&&(t(a).css({left:50*s.data("x"),top:50*s.data("y")}),s.data({x:s.data("x")-o,y:s.data("y")-e}),s.css({left:50*s.data("x"),top:50*s.data("y")}),this.boxIdx=null)},this))):this.pz(s,t(a))&&(s.data({x:s.data("x")-o,y:s.data("y")-e}),s.css({left:50*s.data("x"),top:50*s.data("y")}),this.boxIdx=null)},this))),this.x2=s.data("x"),this.y2=s.data("y"),this.x2==this.x1&&this.y2==this.y1||(this.moveNum++,t(".move-nmu").html(this.moveNum)),this.isSuccess()},isSuccess:function(){var s=0;t(".pos-destination").each(t.proxy(function(i,o){t(".box").each(t.proxy(function(i,e){this.pz(t(o),t(e))&&s++},this))},this)),s===t(".box").length?t(".pass").show(200):t(".pass").hide(200)},pz:function(t,s){var i=t.offset().top,o=t.offset().top+t.height(),e=t.offset().left,a=t.offset().left+t.width(),n=s.offset().top,h=s.offset().top+s.height(),c=s.offset().left,r=s.offset().left+s.width();return o>n&&i<h&&a>c&&e<r}},{start:s}}();return s}()})(jQuery),$.fn.Sokoban.start($(".content"));